<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>MediaPipe Holistic (GPU) - Webcam</title>
  <style>
    body { margin: 0; font-family: Arial, sans-serif; background: #0b0b0b; color: #eaeaea; }
    .wrap { display: grid; place-items: center; height: 100vh; gap: 12px; padding: 18px; }
    .bar { width: min(96vw, 1100px); display: flex; gap: 12px; align-items: center; justify-content: space-between; flex-wrap: wrap; }
    .btn { background: #1c1c1c; color: #eaeaea; border: 1px solid #333; padding: 10px 12px; border-radius: 8px; cursor: pointer; }
    .btn:hover { background: #232323; }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }

    .stage { position: relative; width: min(96vw, 1100px); }
    video { width: 100%; height: auto; border-radius: 10px; background: #000; display: block; transform: scaleX(-1); }
    canvas { position: absolute; inset: 0; width: 100%; height: 100%; border-radius: 10px; pointer-events: none; transform: scaleX(-1); }
    .small { color: #bdbdbd; font-size: 12px; max-width: min(96vw, 1100px); text-align: center; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="bar">
      <div style="display:flex; gap:10px; flex-wrap:wrap;">
        <button class="btn" id="startBtn">Start webcam</button>
        <button class="btn" id="toggleFaceBtn" disabled>Face: ON</button>
        <button class="btn" id="toggleHandsBtn" disabled>Hands: ON</button>
        <button class="btn" id="togglePoseBtn" disabled>Pose: ON</button>
      </div>
      <div class="mono" id="stats">init...</div>
    </div>

    <div class="stage">
      <video id="video" autoplay playsinline muted></video>
      <canvas id="overlay"></canvas>
    </div>

    <div class="small">
      Les compteurs affichent: nb personnes détectées + nb points (pose=33, face=468, hand=21).
    </div>
  </div>

  <script type="module">
    import {
      HolisticLandmarker,
      FilesetResolver,
      DrawingUtils
    } from "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.15";

    const MODEL_URL =
      "https://storage.googleapis.com/mediapipe-models/holistic_landmarker/holistic_landmarker/float16/latest/holistic_landmarker.task";
    const WASM_BASE =
      "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.15/wasm";

    const video = document.getElementById("video");
    const canvas = document.getElementById("overlay");
    const ctx = canvas.getContext("2d");
    const stats = document.getElementById("stats");

    const startBtn = document.getElementById("startBtn");
    const toggleFaceBtn = document.getElementById("toggleFaceBtn");
    const toggleHandsBtn = document.getElementById("toggleHandsBtn");
    const togglePoseBtn = document.getElementById("togglePoseBtn");

    let drawFace = true, drawHands = true, drawPose = true;

    toggleFaceBtn.onclick = () => { drawFace = !drawFace; toggleFaceBtn.textContent = `Face: ${drawFace ? "ON" : "OFF"}`; };
    toggleHandsBtn.onclick = () => { drawHands = !drawHands; toggleHandsBtn.textContent = `Hands: ${drawHands ? "ON" : "OFF"}`; };
    togglePoseBtn.onclick = () => { drawPose = !drawPose; togglePoseBtn.textContent = `Pose: ${drawPose ? "ON" : "OFF"}`; };

    const HAND_CONNECTIONS = [
      [0,1],[1,2],[2,3],[3,4],
      [0,5],[5,6],[6,7],[7,8],
      [5,9],[9,10],[10,11],[11,12],
      [9,13],[13,14],[14,15],[15,16],
      [13,17],[17,18],[18,19],[19,20],
      [0,17]
    ].map(([start, end]) => ({ start, end }));

    const POSE_CONNECTIONS = [
      [11,12],[11,13],[13,15],[12,14],[14,16],
      [11,23],[12,24],[23,24],
      [23,25],[25,27],[24,26],[26,28],
      [27,31],[28,32]
    ].map(([start, end]) => ({ start, end }));

    let holistic = null;
    let drawingUtils = null;

    function showError(e) {
      console.error(e);
      const msg = (e && e.message) ? e.message : String(e);
      stats.textContent = "ERROR: " + msg;
      startBtn.disabled = false;
    }

    async function initHolistic() {
      stats.textContent = "Loading WASM...";
      const fileset = await FilesetResolver.forVisionTasks(WASM_BASE);

      stats.textContent = "Loading model...";
      holistic = await HolisticLandmarker.createFromOptions(fileset, {
        baseOptions: {
          modelAssetPath: MODEL_URL,
          delegate: "GPU",
        },
        runningMode: "VIDEO",
      });

      drawingUtils = new DrawingUtils(ctx);

      toggleFaceBtn.disabled = false;
      toggleHandsBtn.disabled = false;
      togglePoseBtn.disabled = false;

      stats.textContent = "Ready.";
    }

    async function startWebcam() {
      stats.textContent = "Requesting webcam permission...";
      const stream = await navigator.mediaDevices.getUserMedia({
        video: {
          facingMode: "user",
          width: { ideal: 1280 },
          height: { ideal: 720 },
          frameRate: { ideal: 30 }
        },
        audio: false
      });

      video.srcObject = stream;
      await video.play();

      await new Promise((res) => {
        const check = () => (video.videoWidth > 0 ? res() : requestAnimationFrame(check));
        check();
      });

      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;

      stats.textContent = `Webcam: ${canvas.width}x${canvas.height}`;
    }

    let startMs = Date.now();
    let lastT = performance.now();
    let fpsSmooth = 0;

    function ensureCanvasMatchesVideo() {
      if (canvas.width !== video.videoWidth || canvas.height !== video.videoHeight) {
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
      }
    }

    function firstOrNull(arr) {
      // arr est souvent: Landmark[][] (une entrée par personne)
      return (arr && arr.length) ? arr[0] : null;
    }

    function loop() {
      if (video.readyState < 2 || video.videoWidth === 0) {
        stats.textContent = `Waiting video... readyState=${video.readyState}`;
        requestAnimationFrame(loop);
        return;
      }

      ensureCanvasMatchesVideo();

      const nowPerf = performance.now();
      const dt = nowPerf - lastT;
      lastT = nowPerf;
      const fps = 1000 / Math.max(dt, 0.0001);
      fpsSmooth = fpsSmooth === 0 ? fps : (0.9 * fpsSmooth + 0.1 * fps);

      ctx.clearRect(0, 0, canvas.width, canvas.height);

      const tsMs = Date.now() - startMs;
      const result = holistic.detectForVideo(video, tsMs);

      // Nombre de personnes détectées
      const nPosePeople = result.poseLandmarks?.length ?? 0;
      const nFacePeople = result.faceLandmarks?.length ?? 0;
      const nLPeople = result.leftHandLandmarks?.length ?? 0;
      const nRPeople = result.rightHandLandmarks?.length ?? 0;

      // Landmarks de la 1re personne
      const poseLm = firstOrNull(result.poseLandmarks);
      const faceLm = firstOrNull(result.faceLandmarks);
      const leftLm = firstOrNull(result.leftHandLandmarks);
      const rightLm = firstOrNull(result.rightHandLandmarks);

      const posePts = poseLm ? poseLm.length : 0;     // typiquement 33
      const facePts = faceLm ? faceLm.length : 0;     // typiquement 468
      const leftPts = leftLm ? leftLm.length : 0;     // typiquement 21
      const rightPts = rightLm ? rightLm.length : 0;  // typiquement 21

      // DESSIN
      if (drawPose && poseLm) {
        drawingUtils.drawConnectors(poseLm, POSE_CONNECTIONS, { lineWidth: 2 });
        drawingUtils.drawLandmarks(poseLm, { radius: 2 });
      }

      if (drawHands) {
        if (leftLm) {
          drawingUtils.drawConnectors(leftLm, HAND_CONNECTIONS, { lineWidth: 2 });
          drawingUtils.drawLandmarks(leftLm, { radius: 2 });
        }
        if (rightLm) {
          drawingUtils.drawConnectors(rightLm, HAND_CONNECTIONS, { lineWidth: 2 });
          drawingUtils.drawLandmarks(rightLm, { radius: 2 });
        }
      }

      // Face: points only (connecteurs complets = lourd)
      if (drawFace && faceLm) {
        drawingUtils.drawLandmarks(faceLm, { radius: 1 });
      }

      stats.textContent =
        `FPS:${fpsSmooth.toFixed(1)} | ${canvas.width}x${canvas.height} | `
        + `people pose:${nPosePeople} face:${nFacePeople} L:${nLPeople} R:${nRPeople} | `
        + `pts pose:${posePts} face:${facePts} L:${leftPts} R:${rightPts} | GPU`;

      requestAnimationFrame(loop);
    }

    startBtn.onclick = async () => {
      startBtn.disabled = true;
      try {
        await initHolistic();
        await startWebcam();
        startMs = Date.now();
        requestAnimationFrame(loop);
      } catch (e) {
        showError(e);
      }
    };
  </script>
</body>
</html>
